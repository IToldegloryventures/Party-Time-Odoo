<?xml version="1.0" encoding="UTF-8"?>
<templates id="template" xml:space="preserve">
    <!--
        PTT Project Dashboard Template
        
        Matches the screenshot layout:
        - Header with greeting, filters, and Print button
        - 6 KPI tiles in 2 rows (purple/lavender borders)
        - All Task table + Task Deadline pie chart
        - Task By Stages doughnut + Task By Project bar
        - Activities table + Priority bar chart
        
        NO Timesheet Hours (enterprise feature)
    -->
    <t t-name="ptt_project_management.Dashboard">
        <div class="ptt-dashboard container-fluid p-0">
            <!-- Error Message -->
            <div t-if="state.error" class="alert alert-danger m-4" role="alert">
                <i class="fa fa-exclamation-triangle me-2"/>
                <strong>Error:</strong> <t t-esc="state.error"/>
                <button type="button" class="btn btn-sm btn-outline-danger ms-3" t-on-click="() => location.reload()">
                    <i class="fa fa-refresh me-1"/> Refresh Page
                </button>
            </div>

            <!-- Loading Spinner -->
            <div t-elif="state.loading" class="d-flex justify-content-center align-items-center" style="min-height: 400px;">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>

            <div t-else="">
                <!-- Header Section - Pink/Lavender gradient -->
                <div class="ptt-dashboard-header">
                    <div class="row align-items-center">
                        <!-- User greeting with avatar -->
                        <div class="col-md-4">
                            <div class="d-flex align-items-center gap-3">
                                <!-- User Avatar -->
                                <div class="ptt-user-avatar rounded-circle d-flex align-items-center justify-content-center overflow-hidden">
                                    <img t-if="state.userAvatar" t-att-src="state.userAvatar" alt="User"/>
                                    <i t-else="" class="fa fa-user fa-2x" style="color: #8b5cf6;"/>
                                </div>
                                <div>
                                    <h4 class="mb-1">
                                        <t t-esc="getGreeting()"/>, <t t-esc="state.userName"/>.
                                    </h4>
                                    <p class="mb-0">Welcome to your Project Dashboard.</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Filters Row 1 - Main Filters -->
                        <div class="col-md-6">
                            <div class="row g-2 align-items-end mb-2">
                                <div class="col">
                                    <label class="form-label small mb-1">Managers</label>
                                    <select class="form-select form-select-sm" t-ref="managerSelect" t-on-change="applyFilters">
                                        <option value="">All Managers</option>
                                        <t t-foreach="state.managers" t-as="manager" t-key="manager.id">
                                            <option t-att-value="manager.id"><t t-esc="manager.name"/></option>
                                        </t>
                                    </select>
                                </div>
                                <div class="col">
                                    <label class="form-label small mb-1">Customers</label>
                                    <select class="form-select form-select-sm" t-ref="customerSelect" t-on-change="applyFilters">
                                        <option value="">All Customers</option>
                                        <t t-foreach="state.customers" t-as="customer" t-key="customer.id">
                                            <option t-att-value="customer.id"><t t-esc="customer.name"/></option>
                                        </t>
                                    </select>
                                </div>
                                <div class="col">
                                    <label class="form-label small mb-1">Projects</label>
                                    <select class="form-select form-select-sm" t-ref="projectSelect" t-on-change="applyFilters">
                                        <option value="">All Projects</option>
                                        <t t-foreach="state.projects" t-as="project" t-key="project.id">
                                            <option t-att-value="project.id"><t t-esc="project.name"/></option>
                                        </t>
                                    </select>
                                </div>
                                <div class="col">
                                    <label class="form-label small mb-1">Date Period</label>
                                    <select class="form-select form-select-sm" t-ref="datePreset" t-on-change="applyDatePreset">
                                        <option value="">Lifetime</option>
                                        <optgroup label="Current Period">
                                            <option value="today">Today</option>
                                            <option value="week">This Week</option>
                                            <option value="month">This Month</option>
                                            <option value="year">This Year</option>
                                        </optgroup>
                                        <optgroup label="Quarters">
                                            <option value="q1">Q1 (Jan-Mar)</option>
                                            <option value="q2">Q2 (Apr-Jun)</option>
                                            <option value="q3">Q3 (Jul-Sep)</option>
                                            <option value="q4">Q4 (Oct-Dec)</option>
                                        </optgroup>
                                        <optgroup label="Previous Period">
                                            <option value="last_week">Last Week</option>
                                            <option value="last_month">Last Month</option>
                                            <option value="last_quarter">Last Quarter</option>
                                            <option value="last_year">Last Year</option>
                                        </optgroup>
                                        <optgroup label="Custom">
                                            <option value="custom">Custom Range...</option>
                                        </optgroup>
                                    </select>
                                </div>
                            </div>
                            <!-- Filters Row 2 - Custom Date Range and Presets -->
                            <div class="row g-2 align-items-end">
                                <div class="col-auto">
                                    <label class="form-label small mb-1">From</label>
                                    <input type="date" class="form-control form-control-sm" 
                                           t-ref="startDate" t-on-change="applyCustomDateRange"
                                           style="width: 130px;"/>
                                </div>
                                <div class="col-auto">
                                    <label class="form-label small mb-1">To</label>
                                    <input type="date" class="form-control form-control-sm" 
                                           t-ref="endDate" t-on-change="applyCustomDateRange"
                                           style="width: 130px;"/>
                                </div>
                                <div class="col">
                                    <label class="form-label small mb-1">Saved Presets</label>
                                    <div class="input-group input-group-sm">
                                        <select class="form-select form-select-sm" t-ref="presetSelect" t-on-change="loadFilterPreset">
                                            <option value="">Select preset...</option>
                                            <t t-foreach="state.presets" t-as="preset" t-key="preset.id">
                                                <option t-att-value="preset.id"><t t-esc="preset.name"/></option>
                                            </t>
                                        </select>
                                        <button class="btn btn-outline-secondary" type="button" 
                                                t-on-click="saveFilterPreset" title="Save current filters">
                                            <i class="fa fa-save"/>
                                        </button>
                                    </div>
                                </div>
                                <div class="col-auto">
                                    <button class="btn btn-sm btn-outline-secondary" t-on-click="resetFilters" title="Reset all filters">
                                        <i class="fa fa-times me-1"/>Reset
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="col-md-2 text-end">
                            <div class="d-flex flex-column gap-2 align-items-end">
                                <div class="btn-group">
                                    <button class="ptt-refresh-btn" t-on-click="() => this.refreshDashboard(false)" 
                                            t-att-disabled="state.refreshing">
                                        <i t-att-class="state.refreshing ? 'fa fa-spinner fa-spin me-2' : 'fa fa-refresh me-2'"/>
                                        <t t-if="state.refreshing">Refreshing...</t>
                                        <t t-else="">Refresh</t>
                                    </button>
                                </div>
                                <div class="btn-group">
                                    <button class="ptt-export-btn" t-on-click="exportToExcel">
                                        <i class="fa fa-file-excel-o me-2"/>Export
                                    </button>
                                    <button class="ptt-print-btn" t-on-click="printDashboard">
                                        <i class="fa fa-print me-2"/>Print
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- KPI Tiles Row 1 -->
                <div class="row g-3 mb-3 px-3">
                    <div class="col-md-4">
                        <div class="card ptt-kpi-card h-100" t-on-click="openMyTasks" style="cursor: pointer;">
                            <div class="card-body text-center">
                                <h2 class="mb-1"><t t-esc="state.myTasks"/></h2>
                                <p class="mb-0">My Tasks</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card ptt-kpi-card h-100" t-on-click="openTotalProjects" style="cursor: pointer;">
                            <div class="card-body text-center">
                                <h2 class="mb-1"><t t-esc="state.totalProjects"/></h2>
                                <p class="mb-0">Total Projects</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card ptt-kpi-card h-100" t-on-click="openActiveTasks" style="cursor: pointer;">
                            <div class="card-body text-center">
                                <h2 class="mb-1"><t t-esc="state.activeTasks"/></h2>
                                <p class="mb-0">Active Tasks</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- KPI Tiles Row 2 -->
                <div class="row g-3 mb-4 px-3">
                    <div class="col-md-4">
                        <div class="card ptt-kpi-card h-100" t-on-click="openMyOverdueTasks" style="cursor: pointer;">
                            <div class="card-body text-center">
                                <h2 class="mb-1"><t t-esc="state.myOverdueTasks"/></h2>
                                <p class="mb-0">My Overdue Tasks</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card ptt-kpi-card h-100" t-on-click="openOverdueTasks" style="cursor: pointer;">
                            <div class="card-body text-center">
                                <h2 class="mb-1"><t t-esc="state.overdueTasks"/></h2>
                                <p class="mb-0">Overdue Tasks</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card ptt-kpi-card h-100" t-on-click="openTodayTasks" style="cursor: pointer;">
                            <div class="card-body text-center">
                                <h2 class="mb-1"><t t-esc="state.todayTasks"/></h2>
                                <p class="mb-0">Today's Tasks</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- All Task Table + Task Deadline Chart -->
                <div class="row g-3 mb-4 px-3">
                    <div class="col-lg-7">
                        <div class="card ptt-list-card h-100">
                            <div class="card-header">
                                <h5>All Tasks</h5>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead>
                                            <tr>
                                                <th>Name</th>
                                                <th>Project</th>
                                                <th>Deadline-Date</th>
                                                <th>Priority</th>
                                                <th class="text-center">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <t t-foreach="state.tasks" t-as="task" t-key="task.id">
                                                <tr>
                                                    <td><t t-esc="task.name"/></td>
                                                    <td><t t-esc="task.project_name"/></td>
                                                    <td>
                                                        <span class="ptt-deadline-badge">
                                                            <t t-esc="task.deadline_display"/>
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <!-- Odoo 19: 0=Low, 1=Medium, 2=High, 3=Urgent -->
                                                        <i t-if="task.priority === '3'" class="fa fa-flag text-danger" title="Urgent"/>
                                                        <i t-elif="task.priority === '2'" class="fa fa-flag text-warning" title="High Priority"/>
                                                        <i t-elif="task.priority === '1'" class="fa fa-flag text-info" title="Medium Priority"/>
                                                        <i t-else="" class="fa fa-flag-o text-muted" title="Low Priority"/>
                                                    </td>
                                                    <td class="text-center">
                                                        <div class="btn-group btn-group-sm">
                                                            <button class="btn btn-sm btn-outline-primary ptt-assign-btn" 
                                                                    t-on-click="() => this.assignTask(task.id)"
                                                                    title="Quick Assign">
                                                                <i class="fa fa-user-plus"/>
                                                            </button>
                                                            <button class="ptt-view-btn" t-on-click="() => this.viewTask(task.id)">View</button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            </t>
                                            <tr t-if="state.tasks.length === 0">
                                                <td colspan="5" class="text-center text-muted py-4">No tasks found</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="card-footer bg-white ptt-pagination">
                                <button class="ptt-pagination-btn" t-on-click="prevTaskPage" t-att-disabled="state.taskPage &lt;= 1">
                                    <i class="fa fa-chevron-left"/>
                                </button>
                                <span class="ptt-pagination-text">Page <t t-esc="state.taskPage"/> of <t t-esc="state.taskPages"/></span>
                                <button class="ptt-pagination-btn" t-on-click="nextTaskPage" t-att-disabled="state.taskPage >= state.taskPages">
                                    <i class="fa fa-chevron-right"/>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-5">
                        <div class="card ptt-chart-card h-100">
                            <div class="card-header">
                                <h5>Task Deadline</h5>
                                <i class="fa fa-download" title="Download Chart" style="cursor: pointer;" t-on-click="() => this.downloadChart('deadline', 'Task_Deadline')"/>
                            </div>
                            <div class="card-body d-flex align-items-center justify-content-center">
                                <canvas t-ref="taskDeadlineChart" style="max-height: 220px;"/>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Task By Stages + Task By Project -->
                <div class="row g-3 mb-4 px-3">
                    <div class="col-lg-5">
                        <div class="card ptt-chart-card h-100">
                            <div class="card-header">
                                <h5>Task By Stages</h5>
                                <i class="fa fa-download" title="Download Chart" style="cursor: pointer;" t-on-click="() => this.downloadChart('stages', 'Task_By_Stages')"/>
                            </div>
                            <div class="card-body d-flex align-items-center justify-content-center">
                                <canvas t-ref="taskStagesChart" style="max-height: 220px;"/>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-7">
                        <div class="card ptt-chart-card h-100">
                            <div class="card-header">
                                <h5>Task By Project</h5>
                                <i class="fa fa-download" title="Download Chart" style="cursor: pointer;" t-on-click="() => this.downloadChart('project', 'Task_By_Project')"/>
                            </div>
                            <div class="card-body">
                                <canvas t-ref="taskProjectChart" style="height: 220px;"/>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Activities Table + Priority Chart -->
                <div class="row g-3 mb-4 px-3">
                    <div class="col-lg-7">
                        <div class="card ptt-list-card h-100">
                            <div class="card-header">
                                <h5>Activities</h5>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead>
                                            <tr>
                                                <th>Task</th>
                                                <th>Activity</th>
                                                <th>Summary</th>
                                                <th>Date</th>
                                                <th></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <t t-foreach="state.activities" t-as="activity" t-key="activity.id">
                                                <tr>
                                                    <td><t t-esc="activity.task_name"/></td>
                                                    <td><t t-esc="activity.activity_type"/></td>
                                                    <td><t t-esc="activity.summary"/></td>
                                                    <td><t t-esc="activity.date"/></td>
                                                    <td>
                                                        <button class="ptt-view-btn" t-on-click="() => this.viewActivity(activity.res_model, activity.res_id)">View</button>
                                                    </td>
                                                </tr>
                                            </t>
                                            <tr t-if="state.activities.length === 0">
                                                <td colspan="5" class="text-center text-muted py-4">No activities found</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="card-footer bg-white ptt-pagination">
                                <button class="ptt-pagination-btn" t-on-click="prevActivityPage" t-att-disabled="state.activityPage &lt;= 1">
                                    <i class="fa fa-chevron-left"/>
                                </button>
                                <span class="ptt-pagination-text">Page <t t-esc="state.activityPage"/> of <t t-esc="state.activityPages"/></span>
                                <button class="ptt-pagination-btn" t-on-click="nextActivityPage" t-att-disabled="state.activityPage >= state.activityPages">
                                    <i class="fa fa-chevron-right"/>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-5">
                        <div class="card ptt-chart-card h-100">
                            <div class="card-header">
                                <h5>Priority Wise Chart</h5>
                                <i class="fa fa-download" title="Download Chart" style="cursor: pointer;" t-on-click="() => this.downloadChart('priority', 'Priority_Chart')"/>
                            </div>
                            <div class="card-body">
                                <canvas t-ref="priorityChart" style="height: 220px;"/>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </t>
</templates>
