<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Search View (defined first so action can reference it) -->
    <record id="ptt_sales_commission_view_search" model="ir.ui.view">
        <field name="name">ptt.sales.commission.search</field>
        <field name="model">ptt.sales.commission</field>
        <field name="arch" type="xml">
            <search string="Sales Commission Reports">
                <field name="x_sales_rep_name" string="Sales Rep"/>
                <field name="report_month" string="Month"/>
                
                <separator/>
                <filter name="filter_month" string="Month" date="report_month" default_period="month"/>
                
                <group expand="0" string="Group By">
                    <filter string="Sales Rep" name="group_by_rep" context="{'group_by': 'sales_rep_id'}"/>
                    <filter string="Month" name="group_by_month" context="{'group_by': 'report_month:month'}"/>
                </group>
            </search>
        </field>
    </record>

    <!-- Action (defined after search view so it can reference it) -->
    <record id="action_ptt_sales_commission" model="ir.actions.act_window">
        <field name="name">Sales Commission Reports</field>
        <field name="res_model">ptt.sales.commission</field>
        <field name="view_mode">list,pivot,form</field>
        <field name="search_view_id" ref="ptt_sales_commission_view_search"/>
        <field name="context">{'search_default_filter_month': 1, 'search_default_group_by_month': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Create Sales Commission Reports
            </p>
            <p>
                Commission reports show revenue, margins, and calculated commission for each sales rep by month.
                Reports default to the current month but can be filtered to any month.
                Use the Pivot view for spreadsheet-like analysis and Excel export.
            </p>
        </field>
    </record>

    <!-- Tree/List View -->
    <record id="ptt_sales_commission_view_tree" model="ir.ui.view">
        <field name="name">ptt.sales.commission.tree</field>
        <field name="model">ptt.sales.commission</field>
        <field name="arch" type="xml">
            <list string="Sales Commission Reports" decoration-info="report_month == context_today().replace(day=1)" decoration-muted="report_month &lt; context_today().replace(day=1)">
                <field name="x_sales_rep_name"/>
                <field name="report_month" widget="date"/>
                <field name="total_revenue" widget="monetary" options="{'currency_field': 'currency_id'}"/>
                <field name="total_margin" widget="monetary" options="{'currency_field': 'currency_id'}"/>
                <field name="margin_percent" widget="percentage"/>
                <field name="commission_amount" widget="monetary" options="{'currency_field': 'currency_id'}" decoration-success="commission_amount > 0"/>
                <field name="commission_percent" widget="percentage"/>
            </list>
        </field>
    </record>

    <!-- Form View -->
    <record id="ptt_sales_commission_view_form" model="ir.ui.view">
        <field name="name">ptt.sales.commission.form</field>
        <field name="model">ptt.sales.commission</field>
        <field name="arch" type="xml">
            <form string="Sales Commission Report">
                <header>
                    <button name="%(ptt_operational_dashboard.action_ptt_sales_commission)d" type="action" string="Back to List" class="oe_link"/>
                </header>
                <sheet>
                    <group>
                        <group>
                            <field name="sales_rep_id" options="{'no_create': True}"/>
                            <field name="x_sales_rep_name" readonly="1"/>
                            <field name="report_month" widget="date" options="{'datepicker': {'mode': 'month'}}"/>
                        </group>
                        <group>
                            <field name="month_start" readonly="1"/>
                            <field name="month_end" readonly="1"/>
                            <field name="currency_id" invisible="1"/>
                        </group>
                    </group>
                    
                    <notebook>
                        <page string="Revenue &amp; Margin">
                            <group>
                                <group string="Revenue">
                                    <field name="total_revenue" widget="monetary" options="{'currency_field': 'currency_id'}" readonly="1"/>
                                </group>
                                <group string="Margin">
                                    <field name="total_margin" widget="monetary" options="{'currency_field': 'currency_id'}" readonly="1"/>
                                    <field name="margin_percent" widget="percentage" readonly="1"/>
                                </group>
                            </group>
                        </page>
                        <page string="Commission">
                            <group>
                                <group string="Commission Calculation">
                                    <field name="commission_amount" widget="monetary" options="{'currency_field': 'currency_id'}" readonly="1"/>
                                    <field name="commission_percent" widget="percentage" readonly="1"/>
                                </group>
                            </group>
                            <div class="alert alert-info" role="alert">
                                <strong>Note:</strong> Commission calculation will be configured based on business rules.
                                Currently showing placeholder values.
                            </div>
                        </page>
                    </notebook>
                </sheet>
            </form>
        </field>
    </record>

    <!-- Server Action to Create Monthly Reports -->
    <record id="action_create_monthly_commission_reports" model="ir.actions.server">
        <field name="name">Create Monthly Commission Reports</field>
        <field name="model_id" ref="model_ptt_sales_commission"/>
        <field name="binding_model_id" ref="model_ptt_sales_commission"/>
        <field name="binding_view_types">list</field>
        <field name="state">code</field>
        <field name="code">
action = model.create_monthly_reports()
        </field>
    </record>
</odoo>

