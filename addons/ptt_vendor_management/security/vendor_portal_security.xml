<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        
        <!-- Vendor Portal Access Group -->
        <record id="privilege_vendor_portal" model="res.groups.privilege">
            <field name="name">Vendor Portal</field>
            <field name="category_id" ref="base.module_category_services"/>
        </record>
        <record id="group_vendor_portal" model="res.groups">
            <field name="name">Vendor Portal User</field>
            <field name="privilege_id" ref="privilege_vendor_portal"/>
            <field name="comment">Users in this group are vendors with portal access to view their event assignments.</field>
        </record>
        
        <!-- Record Rules for Vendor Portal Access -->
        
        <!-- Vendors can only see their own assignments -->
        <record id="rule_vendor_assignment_portal" model="ir.rule">
            <field name="name">Vendor Assignment: portal users see own</field>
            <field name="model_id" ref="ptt_business_core.model_ptt_project_vendor_assignment"/>
            <field name="domain_force">[('vendor_id', '=', user.partner_id.id)]</field>
            <field name="groups" eval="[(4, ref('base.group_portal'))]"/>
            <field name="perm_read" eval="True"/>
            <field name="perm_write" eval="True"/>
            <field name="perm_create" eval="False"/>
            <field name="perm_unlink" eval="False"/>
        </record>
        
        <!-- Vendors can see documents on their assignments -->
        <record id="rule_vendor_document_portal" model="ir.rule">
            <field name="name">Vendor Document: portal users see own</field>
            <field name="model_id" ref="model_ptt_vendor_document"/>
            <field name="domain_force">[
                ('vendor_assignment_id.vendor_id', '=', user.partner_id.id),
                ('visible_to_vendor', '=', True)
            ]</field>
            <field name="groups" eval="[(4, ref('base.group_portal'))]"/>
            <field name="perm_read" eval="True"/>
            <field name="perm_write" eval="False"/>
            <field name="perm_create" eval="False"/>
            <field name="perm_unlink" eval="False"/>
        </record>
        
        <!-- Vendors can see limited project info -->
        <record id="rule_project_portal_vendor" model="ir.rule">
            <field name="name">Project: vendor portal users see assigned</field>
            <field name="model_id" ref="project.model_project_project"/>
            <field name="domain_force">[('ptt_vendor_assignment_ids.vendor_id', '=', user.partner_id.id)]</field>
            <field name="groups" eval="[(4, ref('base.group_portal'))]"/>
            <field name="perm_read" eval="True"/>
            <field name="perm_write" eval="False"/>
            <field name="perm_create" eval="False"/>
            <field name="perm_unlink" eval="False"/>
        </record>
        
        <!-- ============================================ -->
        <!-- RFQ Record Rules                            -->
        <!-- ============================================ -->
        
        <!-- Portal vendors can see RFQs sent to them -->
        <record id="rule_vendor_rfq_portal" model="ir.rule">
            <field name="name">Vendor RFQ: portal users see invited</field>
            <field name="model_id" ref="model_ptt_vendor_rfq"/>
            <field name="domain_force">[('vendor_ids', 'in', [user.partner_id.id])]</field>
            <field name="groups" eval="[(4, ref('base.group_portal'))]"/>
            <field name="perm_read" eval="True"/>
            <field name="perm_write" eval="False"/>
            <field name="perm_create" eval="False"/>
            <field name="perm_unlink" eval="False"/>
        </record>
        
        <!-- Portal vendors can see and create their own quote history -->
        <record id="rule_vendor_quote_history_portal" model="ir.rule">
            <field name="name">Quote History: portal users manage own</field>
            <field name="model_id" ref="model_ptt_vendor_quote_history"/>
            <field name="domain_force">[('vendor_id', '=', user.partner_id.id)]</field>
            <field name="groups" eval="[(4, ref('base.group_portal'))]"/>
            <field name="perm_read" eval="True"/>
            <field name="perm_write" eval="True"/>
            <field name="perm_create" eval="True"/>
            <field name="perm_unlink" eval="False"/>
        </record>
        
        <!-- ============================================ -->
        <!-- Additional Security Hardening Rules         -->
        <!-- ============================================ -->
        
        <!-- Ensure internal users can see all assignments -->
        <record id="rule_vendor_assignment_user" model="ir.rule">
            <field name="name">Vendor Assignment: internal users see all</field>
            <field name="model_id" ref="ptt_business_core.model_ptt_project_vendor_assignment"/>
            <field name="domain_force">[(1, '=', 1)]</field>
            <field name="groups" eval="[(4, ref('base.group_user'))]"/>
            <field name="perm_read" eval="True"/>
            <field name="perm_write" eval="True"/>
            <field name="perm_create" eval="True"/>
            <field name="perm_unlink" eval="True"/>
        </record>
        
        <!-- Internal users can manage all RFQs -->
        <record id="rule_vendor_rfq_user" model="ir.rule">
            <field name="name">Vendor RFQ: internal users manage all</field>
            <field name="model_id" ref="model_ptt_vendor_rfq"/>
            <field name="domain_force">[(1, '=', 1)]</field>
            <field name="groups" eval="[(4, ref('base.group_user'))]"/>
            <field name="perm_read" eval="True"/>
            <field name="perm_write" eval="True"/>
            <field name="perm_create" eval="True"/>
            <field name="perm_unlink" eval="True"/>
        </record>
        
        <!-- Internal users can manage all quote history -->
        <record id="rule_vendor_quote_history_user" model="ir.rule">
            <field name="name">Quote History: internal users manage all</field>
            <field name="model_id" ref="model_ptt_vendor_quote_history"/>
            <field name="domain_force">[(1, '=', 1)]</field>
            <field name="groups" eval="[(4, ref('base.group_user'))]"/>
            <field name="perm_read" eval="True"/>
            <field name="perm_write" eval="True"/>
            <field name="perm_create" eval="True"/>
            <field name="perm_unlink" eval="True"/>
        </record>
        
        <!-- Portal vendors cannot access CRM leads directly -->
        <record id="rule_crm_lead_portal_restrict" model="ir.rule">
            <field name="name">CRM Lead: portal users no access</field>
            <field name="model_id" ref="crm.model_crm_lead"/>
            <field name="domain_force">[(0, '=', 1)]</field>
            <field name="groups" eval="[(4, ref('base.group_portal'))]"/>
            <field name="perm_read" eval="True"/>
            <field name="perm_write" eval="False"/>
            <field name="perm_create" eval="False"/>
            <field name="perm_unlink" eval="False"/>
        </record>
        
    </data>
</odoo>
