<?xml version="1.0" encoding="utf-8"?>
<odoo>
    
    <!--
        Vendor RFQ Portal Templates
        
        Allow vendors to view RFQs they're invited to and submit quotes.
    -->
    
    <!-- ==================== PORTAL BREADCRUMB EXTENSION ==================== -->
    <template id="portal_my_home_menu_vendor_rfq"
              name="Portal Vendor RFQ Breadcrumb"
              inherit_id="portal.portal_breadcrumbs"
              priority="25">
        <xpath expr="//ol[hasclass('o_portal_submenu')]" position="inside">
            <li t-if="page_name == 'vendor_rfq'"
                t-attf-class="breadcrumb-item #{'active' if not vendor_rfq else ''}">
                <a t-if="vendor_rfq" t-attf-href="/my/vendor_rfqs?{{ keep_query() }}">RFQs</a>
                <t t-else="">RFQs</t>
            </li>
            <li t-if="vendor_rfq" class="breadcrumb-item active">
                <t t-esc="vendor_rfq.name"/>
            </li>
        </xpath>
    </template>
    
    <!-- ==================== PORTAL HOME CARD ==================== -->
    <template id="portal_my_home_vendor_rfq"
              name="Show Vendor RFQs"
              inherit_id="portal.portal_my_home"
              priority="26">
        <xpath expr="//div[hasclass('o_portal_docs')]" position="inside">
            <t t-call="portal.portal_docs_entry">
                <t t-set="icon" t-value="'/ptt_vendor_management/static/description/icon.png'"/>
                <t t-set="title">Quote Requests</t>
                <t t-set="url" t-value="'/my/vendor_rfqs'"/>
                <t t-set="text">View and respond to quote requests</t>
                <t t-set="placeholder_count" t-value="'rfq_count'"/>
            </t>
        </xpath>
    </template>
    
    <!-- ==================== RFQ LIST PAGE ==================== -->
    <template id="portal_my_vendor_rfqs" name="My Vendor RFQs">
        <t t-call="portal.portal_layout">
            <t t-set="breadcrumbs_searchbar" t-value="True"/>
            
            <t t-call="portal.portal_searchbar">
                <t t-set="title">Quote Requests</t>
            </t>
            
            <t t-if="not rfqs">
                <div class="alert alert-info mt-3">
                    <i class="fa fa-info-circle me-2"/>
                    You have no quote requests at this time.
                </div>
            </t>
            
            <t t-if="rfqs">
                <div class="table-responsive mt-3">
                    <table class="table table-hover o_portal_my_doc_table">
                        <thead class="bg-light">
                            <tr>
                                <th>Reference</th>
                                <th>Product/Service</th>
                                <th>Quantity</th>
                                <th>Quote Date</th>
                                <th>Closing Date</th>
                                <th class="text-center">Status</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            <t t-foreach="rfqs" t-as="rfq">
                                <tr>
                                    <td>
                                        <a t-attf-href="/my/vendor_rfq/#{rfq.id}">
                                            <strong><t t-esc="rfq.name"/></strong>
                                        </a>
                                    </td>
                                    <td>
                                        <t t-if="rfq.product_id">
                                            <t t-esc="rfq.product_id.name"/>
                                        </t>
                                        <t t-else="">
                                            <span class="text-muted">Custom Request</span>
                                        </t>
                                    </td>
                                    <td><t t-esc="rfq.quantity"/></td>
                                    <td><t t-esc="rfq.quote_date" t-options="{'widget': 'date'}"/></td>
                                    <td>
                                        <t t-if="rfq.closing_date">
                                            <t t-esc="rfq.closing_date" t-options="{'widget': 'date'}"/>
                                        </t>
                                        <t t-else="">Open</t>
                                    </td>
                                    <td class="text-center">
                                        <span t-attf-class="badge rounded-pill #{
                                            'bg-info' if rfq.state == 'in_progress' else
                                            'bg-success' if rfq.state == 'done' else
                                            'bg-primary' if rfq.state == 'order' else
                                            'bg-danger' if rfq.state == 'cancel' else
                                            'bg-secondary'
                                        }">
                                            <t t-if="rfq.state == 'in_progress'">Open</t>
                                            <t t-elif="rfq.state == 'done'">Closed</t>
                                            <t t-elif="rfq.state == 'order'">Ordered</t>
                                            <t t-elif="rfq.state == 'cancel'">Cancelled</t>
                                            <t t-else=""><t t-esc="rfq.state"/></t>
                                        </span>
                                    </td>
                                    <td class="text-end">
                                        <a t-attf-href="/my/vendor_rfq/#{rfq.id}" 
                                           class="btn btn-sm btn-primary">
                                            <i class="fa fa-eye me-1"/>View
                                        </a>
                                    </td>
                                </tr>
                            </t>
                        </tbody>
                    </table>
                </div>
                
                <t t-if="pager">
                    <div class="d-flex justify-content-center mt-3">
                        <t t-call="portal.pager"/>
                    </div>
                </t>
            </t>
        </t>
    </template>
    
    <!-- ==================== RFQ DETAIL PAGE ==================== -->
    <template id="portal_vendor_rfq_detail" name="Vendor RFQ Detail">
        <t t-call="portal.portal_layout">
            
            <div class="container py-4">
                
                <!-- Status Alerts -->
                <t t-if="vendor_rfq.state == 'in_progress' and not my_quote">
                    <div class="alert alert-info">
                        <i class="fa fa-info-circle me-2"/>
                        This quote request is open. Submit your quote below.
                    </div>
                </t>
                
                <t t-if="vendor_rfq.state == 'in_progress' and my_quote">
                    <div class="alert alert-success">
                        <i class="fa fa-check-circle me-2"/>
                        You have submitted a quote of 
                        <strong>$<t t-esc="'%.2f' % my_quote.quoted_price"/></strong>.
                        You can update it until the closing date.
                    </div>
                </t>
                
                <t t-if="vendor_rfq.state == 'done' and vendor_rfq.approved_vendor_id.id == partner.id">
                    <div class="alert alert-success">
                        <i class="fa fa-trophy me-2"/>
                        <strong>Congratulations!</strong> Your quote was selected!
                    </div>
                </t>
                
                <t t-if="vendor_rfq.state in ['done', 'order'] and vendor_rfq.approved_vendor_id.id != partner.id">
                    <div class="alert alert-warning">
                        <i class="fa fa-info-circle me-2"/>
                        This RFQ has been closed. Another vendor was selected.
                    </div>
                </t>
                
                <t t-if="vendor_rfq.state == 'cancel'">
                    <div class="alert alert-danger">
                        <i class="fa fa-times-circle me-2"/>
                        This quote request has been cancelled.
                    </div>
                </t>
                
                <!-- Header -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><t t-esc="vendor_rfq.name"/></h2>
                    <span t-attf-class="badge rounded-pill fs-6 #{
                        'bg-info' if vendor_rfq.state == 'in_progress' else
                        'bg-success' if vendor_rfq.state == 'done' else
                        'bg-primary' if vendor_rfq.state == 'order' else
                        'bg-danger' if vendor_rfq.state == 'cancel' else
                        'bg-secondary'
                    }">
                        <t t-if="vendor_rfq.state == 'in_progress'">Open for Quotes</t>
                        <t t-elif="vendor_rfq.state == 'done'">Closed</t>
                        <t t-elif="vendor_rfq.state == 'order'">Ordered</t>
                        <t t-elif="vendor_rfq.state == 'cancel'">Cancelled</t>
                    </span>
                </div>
                
                <div class="row">
                    <!-- RFQ Details -->
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fa fa-file-text me-2"/>Request Details</h5>
                            </div>
                            <div class="card-body">
                                <dl class="row mb-0">
                                    <t t-if="vendor_rfq.product_id">
                                        <dt class="col-sm-5">Product/Service</dt>
                                        <dd class="col-sm-7"><t t-esc="vendor_rfq.product_id.name"/></dd>
                                    </t>
                                    
                                    <t t-if="vendor_rfq.description">
                                        <dt class="col-sm-5">Description</dt>
                                        <dd class="col-sm-7"><t t-raw="vendor_rfq.description"/></dd>
                                    </t>
                                    
                                    <dt class="col-sm-5">Quantity</dt>
                                    <dd class="col-sm-7">
                                        <t t-esc="vendor_rfq.quantity"/>
                                        <t t-if="vendor_rfq.uom_id"> <t t-esc="vendor_rfq.uom_id.name"/></t>
                                    </dd>
                                    
                                    <t t-if="vendor_rfq.estimated_quote">
                                        <dt class="col-sm-5">Budget Estimate</dt>
                                        <dd class="col-sm-7">
                                            $<t t-esc="'%.2f' % vendor_rfq.estimated_quote"/>
                                        </dd>
                                    </t>
                                </dl>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Schedule -->
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fa fa-calendar me-2"/>Schedule</h5>
                            </div>
                            <div class="card-body">
                                <dl class="row mb-0">
                                    <dt class="col-sm-5">Quote Date</dt>
                                    <dd class="col-sm-7">
                                        <t t-esc="vendor_rfq.quote_date" t-options="{'widget': 'date'}"/>
                                    </dd>
                                    
                                    <dt class="col-sm-5">Closing Date</dt>
                                    <dd class="col-sm-7">
                                        <t t-if="vendor_rfq.closing_date">
                                            <strong><t t-esc="vendor_rfq.closing_date" t-options="{'widget': 'date'}"/></strong>
                                        </t>
                                        <t t-else="">Open (No deadline)</t>
                                    </dd>
                                    
                                    <t t-if="vendor_rfq.estimated_delivery_date">
                                        <dt class="col-sm-5">Requested Delivery</dt>
                                        <dd class="col-sm-7">
                                            <t t-esc="vendor_rfq.estimated_delivery_date" t-options="{'widget': 'date'}"/>
                                        </dd>
                                    </t>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Notes -->
                <t t-if="vendor_rfq.notes">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fa fa-sticky-note me-2"/>Additional Notes</h5>
                        </div>
                        <div class="card-body">
                            <t t-raw="vendor_rfq.notes"/>
                        </div>
                    </div>
                </t>
                
                <!-- Quote Form (only if in_progress) -->
                <t t-if="vendor_rfq.state == 'in_progress'">
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">
                                <i class="fa fa-dollar-sign me-2"/>
                                <t t-if="my_quote">Update Your Quote</t>
                                <t t-else="">Submit Your Quote</t>
                            </h5>
                        </div>
                        <div class="card-body">
                            <form action="/vendor_rfq/submit_quote" method="post">
                                <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                <input type="hidden" name="rfq_id" t-att-value="vendor_rfq.id"/>
                                
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label for="price" class="form-label">
                                            Your Quote Price <span class="text-danger">*</span>
                                        </label>
                                        <div class="input-group">
                                            <span class="input-group-text">$</span>
                                            <input type="number" 
                                                   class="form-control" 
                                                   id="price" 
                                                   name="price"
                                                   step="0.01"
                                                   min="0"
                                                   required="required"
                                                   t-att-value="my_quote.quoted_price if my_quote else ''"/>
                                        </div>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="delivery_date" class="form-label">
                                            Estimated Delivery Date
                                        </label>
                                        <input type="date" 
                                               class="form-control" 
                                               id="delivery_date" 
                                               name="delivery_date"
                                               t-att-value="my_quote.estimate_date if my_quote else ''"/>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="note" class="form-label">Notes</label>
                                        <textarea class="form-control" 
                                                  id="note" 
                                                  name="note" 
                                                  rows="1"
                                                  placeholder="Any additional information..."><t t-if="my_quote" t-esc="my_quote.note or ''"/></textarea>
                                    </div>
                                </div>
                                
                                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fa fa-paper-plane me-2"/>
                                        <t t-if="my_quote">Update Quote</t>
                                        <t t-else="">Submit Quote</t>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </t>
                
                <!-- My Quote Summary (if exists and RFQ closed) -->
                <t t-if="my_quote and vendor_rfq.state not in ['in_progress']">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fa fa-check me-2"/>Your Submitted Quote</h5>
                        </div>
                        <div class="card-body">
                            <dl class="row mb-0">
                                <dt class="col-sm-3">Quoted Price</dt>
                                <dd class="col-sm-9">
                                    <strong>$<t t-esc="'%.2f' % my_quote.quoted_price"/></strong>
                                </dd>
                                
                                <t t-if="my_quote.estimate_date">
                                    <dt class="col-sm-3">Delivery Date</dt>
                                    <dd class="col-sm-9">
                                        <t t-esc="my_quote.estimate_date" t-options="{'widget': 'date'}"/>
                                    </dd>
                                </t>
                                
                                <t t-if="my_quote.note">
                                    <dt class="col-sm-3">Notes</dt>
                                    <dd class="col-sm-9"><t t-esc="my_quote.note"/></dd>
                                </t>
                            </dl>
                        </div>
                    </div>
                </t>
                
                <!-- Back Link -->
                <a href="/my/vendor_rfqs" class="btn btn-secondary">
                    <i class="fa fa-arrow-left me-2"/> Back to RFQs
                </a>
                
            </div>
        </t>
    </template>
    
</odoo>
