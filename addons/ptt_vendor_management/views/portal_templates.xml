<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        
        <!-- Vendor Portal Home Link -->
        <template id="portal_my_home_vendor" name="Portal My Home: Vendor Assignments"
                  inherit_id="portal.portal_my_home" priority="30">
            <xpath expr="//div[hasclass('o_portal_docs')]" position="before">
                <t t-set="vendor_assignment_count" t-value="vendor_assignment_count or 0"/>
                <t t-if="vendor_assignment_count > 0">
                    <div class="o_portal_docs mt-4">
                        <h4>Vendor Assignments</h4>
                        <div class="row">
                            <div class="col-lg-4 col-md-6 pb-2">
                                <a href="/my/vendor/assignments" class="d-block text-decoration-none">
                                    <div class="o_portal_index_card bg-white shadow-sm rounded p-3 h-100">
                                        <div class="d-flex align-items-center">
                                            <div class="o_portal_icon me-3">
                                                <i class="fa fa-2x fa-calendar-check-o text-primary"/>
                                            </div>
                                            <div>
                                                <span class="h2 mb-0 fw-bold text-primary" t-esc="vendor_assignment_count"/>
                                                <span class="text-muted d-block">Event Assignments</span>
                                            </div>
                                        </div>
                                    </div>
                                </a>
                            </div>
                        </div>
                    </div>
                </t>
            </xpath>
        </template>
        
        <!-- Vendor Assignments List -->
        <template id="portal_vendor_assignments" name="Vendor Assignments">
            <t t-call="portal.portal_layout">
                <t t-set="breadcrumbs_searchbar" t-value="True"/>
                
                <t t-call="portal.portal_searchbar">
                    <t t-set="title">My Event Assignments</t>
                </t>
                
                <t t-if="not assignments">
                    <div class="alert alert-info text-center" role="alert">
                        <h4 class="alert-heading">No Assignments</h4>
                        <p>You don't have any event assignments at this time.</p>
                    </div>
                </t>
                
                <t t-else="">
                    <div class="o_portal_my_doc_table">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Service</th>
                                    <th>Project/Event</th>
                                    <th>Service Date</th>
                                    <th>Status</th>
                                    <th class="text-end">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-foreach="assignments" t-as="assignment">
                                    <tr>
                                        <td>
                                            <a t-attf-href="/my/vendor/assignment/#{assignment.id}">
                                                <strong t-esc="dict(assignment._fields['service_type'].selection).get(assignment.service_type, '')"/>
                                            </a>
                                        </td>
                                        <td>
                                            <span t-field="assignment.project_id.name"/>
                                            <t t-if="assignment.project_id.ptt_event_name">
                                                <br/>
                                                <small class="text-muted" t-field="assignment.project_id.ptt_event_name"/>
                                            </t>
                                        </td>
                                        <td>
                                            <span t-field="assignment.service_date"/>
                                        </td>
                                        <td>
                                            <span t-attf-class="badge #{assignment.status == 'confirmed' and 'bg-success' or assignment.status == 'pending' and 'bg-warning' or assignment.status == 'completed' and 'bg-info' or 'bg-secondary'}">
                                                <t t-esc="dict(assignment._fields['status'].selection).get(assignment.status, '')"/>
                                            </span>
                                            <t t-if="assignment.vendor_confirmed">
                                                <i class="fa fa-check-circle text-success ms-1" title="You confirmed"/>
                                            </t>
                                        </td>
                                        <td class="text-end">
                                            <a t-attf-href="/my/vendor/assignment/#{assignment.id}" 
                                               class="btn btn-sm btn-outline-primary">
                                                View Details
                                            </a>
                                        </td>
                                    </tr>
                                </t>
                            </tbody>
                        </table>
                    </div>
                    
                    <div t-if="pager" class="o_portal_pager text-center mt-4">
                        <t t-call="portal.pager"/>
                    </div>
                </t>
                
            </t>
        </template>
        
        <!-- Vendor Assignment Detail -->
        <template id="portal_vendor_assignment_detail" name="Vendor Assignment Detail">
            <t t-call="portal.portal_layout">
                
                <t t-set="o_portal_fullwidth_alert" groups="base.group_user">
                    <t t-call="portal.portal_back_in_edit_mode">
                        <t t-set="backend_url" t-value="'/odoo/project.project/' + str(assignment.project_id.id)"/>
                    </t>
                </t>
                
                <t t-call="portal.portal_record_layout">
                    <t t-set="card_header">
                        <div class="row">
                            <div class="col-12 col-md-8">
                                <h4 class="mb-0">
                                    <span t-esc="dict(assignment._fields['service_type'].selection).get(assignment.service_type, '')"/>
                                    <span class="text-muted">-</span>
                                    <span t-field="assignment.project_id.name"/>
                                </h4>
                            </div>
                            <div class="col-12 col-md-4 text-md-end">
                                <span t-attf-class="badge fs-6 #{assignment.status == 'confirmed' and 'bg-success' or assignment.status == 'pending' and 'bg-warning' or assignment.status == 'completed' and 'bg-info' or 'bg-secondary'}">
                                    <t t-esc="dict(assignment._fields['status'].selection).get(assignment.status, '')"/>
                                </span>
                            </div>
                        </div>
                    </t>
                    
                    <t t-set="card_body">
                        <!-- Confirmation Actions -->
                        <t t-if="assignment.status == 'pending' and not assignment.vendor_confirmed">
                            <div class="alert alert-warning">
                                <h5><i class="fa fa-exclamation-triangle"/> Action Required</h5>
                                <p>Please confirm or decline this assignment.</p>
                                <form method="POST" t-attf-action="/my/vendor/assignment/#{assignment.id}/confirm" class="d-inline">
                                    <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                    <button type="submit" class="btn btn-success">
                                        <i class="fa fa-check"/> Confirm Assignment
                                    </button>
                                </form>
                                <form method="POST" t-attf-action="/my/vendor/assignment/#{assignment.id}/decline" class="d-inline ms-2">
                                    <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                    <button type="submit" class="btn btn-outline-danger">
                                        <i class="fa fa-times"/> Decline
                                    </button>
                                </form>
                            </div>
                        </t>
                        
                        <t t-if="assignment.vendor_confirmed">
                            <div class="alert alert-success">
                                <i class="fa fa-check-circle"/> You confirmed this assignment on 
                                <span t-field="assignment.vendor_confirmed_date" t-options='{"format": "medium"}'/>
                            </div>
                        </t>
                        
                        <!-- Event Details -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <h5>Event Information</h5>
                                <dl class="row">
                                    <dt class="col-sm-4">Event Name</dt>
                                    <dd class="col-sm-8" t-field="assignment.project_id.ptt_event_name"/>
                                    
                                    <dt class="col-sm-4">Event Date</dt>
                                    <dd class="col-sm-8" t-field="assignment.project_id.ptt_event_date"/>
                                    
                                    <dt class="col-sm-4">Venue</dt>
                                    <dd class="col-sm-8" t-field="assignment.project_id.ptt_venue_name"/>
                                    
                                    <dt class="col-sm-4">Guest Count</dt>
                                    <dd class="col-sm-8" t-field="assignment.project_id.ptt_guest_count"/>
                                </dl>
                            </div>
                            <div class="col-md-6">
                                <h5>Your Assignment</h5>
                                <dl class="row">
                                    <dt class="col-sm-4">Service</dt>
                                    <dd class="col-sm-8" t-esc="dict(assignment._fields['service_type'].selection).get(assignment.service_type, '')"/>
                                    
                                    <dt class="col-sm-4">Service Date</dt>
                                    <dd class="col-sm-8" t-field="assignment.service_date"/>
                                    
                                    <t t-if="assignment.scheduled_start">
                                        <dt class="col-sm-4">Start Time</dt>
                                        <dd class="col-sm-8" t-field="assignment.scheduled_start"/>
                                    </t>
                                    
                                    <t t-if="assignment.scheduled_end">
                                        <dt class="col-sm-4">End Time</dt>
                                        <dd class="col-sm-8" t-field="assignment.scheduled_end"/>
                                    </t>
                                </dl>
                            </div>
                        </div>
                        
                        <!-- Description -->
                        <t t-if="assignment.description">
                            <h5>Service Description</h5>
                            <div class="mb-4" t-field="assignment.description"/>
                        </t>
                        
                        <!-- Documents -->
                        <t t-if="assignment.document_ids">
                            <h5>Documents</h5>
                            <ul class="list-group mb-4">
                                <t t-foreach="assignment.document_ids.filtered(lambda d: d.visible_to_vendor)" t-as="doc">
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <div>
                                            <i class="fa fa-file me-2"/>
                                            <span t-field="doc.name"/>
                                            <span class="badge bg-secondary ms-2" t-esc="dict(doc._fields['document_type'].selection).get(doc.document_type, '')"/>
                                        </div>
                                        <a t-if="doc.file" t-attf-href="/web/content/ptt.vendor.document/#{doc.id}/file/#{doc.filename}" 
                                           class="btn btn-sm btn-outline-primary" download="">
                                            <i class="fa fa-download"/> Download
                                        </a>
                                    </li>
                                </t>
                            </ul>
                        </t>
                        
                        <!-- Notes -->
                        <t t-if="assignment.notes">
                            <h5>Notes</h5>
                            <div class="mb-4" t-field="assignment.notes"/>
                        </t>
                        
                    </t>
                </t>
                
                <!-- Back button -->
                <div class="mt-4">
                    <a href="/my/vendor/assignments" class="btn btn-secondary">
                        <i class="fa fa-arrow-left"/> Back to Assignments
                    </a>
                </div>
                
            </t>
        </template>

        <!-- ============================================ -->
        <!-- RFQ Portal Templates                        -->
        <!-- ============================================ -->
        
        <!-- Portal Home - Add RFQ Card -->
        <template id="portal_my_home_rfq" name="Portal My Home: Vendor RFQs"
                  inherit_id="portal.portal_my_home" priority="31">
            <xpath expr="//div[hasclass('o_portal_docs')]" position="before">
                <t t-set="rfq_count" t-value="rfq_count or 0"/>
                <t t-if="rfq_count > 0">
                    <div class="o_portal_docs mt-4">
                        <h4>Quote Requests</h4>
                        <div class="row">
                            <div class="col-lg-4 col-md-6 pb-2">
                                <a href="/my/vendor/rfq" class="d-block text-decoration-none">
                                    <div class="o_portal_index_card bg-white shadow-sm rounded p-3 h-100">
                                        <div class="d-flex align-items-center">
                                            <div class="o_portal_icon me-3">
                                                <i class="fa fa-2x fa-file-text-o text-warning"/>
                                            </div>
                                            <div>
                                                <span class="h2 mb-0 fw-bold text-warning" t-esc="rfq_count"/>
                                                <span class="text-muted d-block">Request for Quotes</span>
                                            </div>
                                        </div>
                                    </div>
                                </a>
                            </div>
                        </div>
                    </div>
                </t>
            </xpath>
        </template>

        <!-- RFQ List View -->
        <template id="portal_vendor_rfq_list" name="Vendor RFQ List">
            <t t-call="portal.portal_layout">
                <t t-set="breadcrumbs_searchbar" t-value="True"/>
                
                <t t-call="portal.portal_searchbar">
                    <t t-set="title">Request for Quotes</t>
                </t>
                
                <t t-if="not rfqs">
                    <div class="alert alert-info text-center" role="alert">
                        <h4 class="alert-heading">No Active RFQs</h4>
                        <p>You don't have any Request for Quotes at this time.</p>
                    </div>
                </t>
                
                <t t-else="">
                    <div class="o_portal_my_doc_table">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Reference</th>
                                    <th>Service Type</th>
                                    <th>Event Date</th>
                                    <th>Deadline</th>
                                    <th>Status</th>
                                    <th>Your Quote</th>
                                    <th class="text-end">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-foreach="rfqs" t-as="rfq">
                                    <t t-set="my_quote" t-value="rfq.quote_history_ids.filtered(lambda q: q.vendor_id.id == request.env.user.partner_id.id)[:1]"/>
                                    <tr>
                                        <td>
                                            <a t-attf-href="/my/vendor/rfq/#{rfq.id}">
                                                <strong t-esc="rfq.name"/>
                                            </a>
                                        </td>
                                        <td t-esc="rfq.service_type"/>
                                        <td>
                                            <span t-field="rfq.event_date" t-options='{"format": "MMM dd, yyyy"}'/>
                                        </td>
                                        <td>
                                            <t t-if="rfq.closing_date">
                                                <span t-field="rfq.closing_date" t-options='{"format": "MMM dd, yyyy"}'/>
                                                <t t-if="rfq.closing_date &lt; context_today()">
                                                    <span class="badge bg-danger ms-1">Expired</span>
                                                </t>
                                            </t>
                                            <t t-else="">ASAP</t>
                                        </td>
                                        <td>
                                            <span t-attf-class="badge #{rfq.state == 'sent' and 'bg-info' or rfq.state == 'in_progress' and 'bg-primary' or rfq.state == 'done' and 'bg-secondary' or rfq.state == 'assigned' and 'bg-success' or 'bg-light text-dark'}">
                                                <t t-if="rfq.state == 'sent'">Open</t>
                                                <t t-elif="rfq.state == 'in_progress'">Reviewing</t>
                                                <t t-elif="rfq.state == 'done'">Closed</t>
                                                <t t-elif="rfq.state == 'assigned'">Awarded</t>
                                                <t t-else="" t-esc="rfq.state"/>
                                            </span>
                                        </td>
                                        <td>
                                            <t t-if="my_quote">
                                                <span class="text-success fw-bold">$<t t-esc="'{:,.2f}'.format(my_quote.quoted_price)"/></span>
                                            </t>
                                            <t t-else="">
                                                <span class="text-muted">Not submitted</span>
                                            </t>
                                        </td>
                                        <td class="text-end">
                                            <a t-attf-href="/my/vendor/rfq/#{rfq.id}" 
                                               class="btn btn-sm btn-outline-primary">
                                                <t t-if="not my_quote and rfq.state in ('sent', 'in_progress')">Submit Quote</t>
                                                <t t-else="">View Details</t>
                                            </a>
                                        </td>
                                    </tr>
                                </t>
                            </tbody>
                        </table>
                    </div>
                    
                    <div t-if="pager" class="o_portal_pager text-center mt-4">
                        <t t-call="portal.pager"/>
                    </div>
                </t>
                
            </t>
        </template>

        <!-- RFQ Detail View -->
        <template id="portal_vendor_rfq_detail" name="Vendor RFQ Detail">
            <t t-call="portal.portal_layout">
                
                <t t-call="portal.portal_record_layout">
                    <t t-set="card_header">
                        <div class="row">
                            <div class="col-12 col-md-8">
                                <h4 class="mb-0">
                                    <span t-esc="rfq.name"/>
                                    <span class="text-muted">-</span>
                                    <span t-esc="rfq.service_type"/>
                                </h4>
                            </div>
                            <div class="col-12 col-md-4 text-md-end">
                                <span t-attf-class="badge fs-6 #{rfq.state == 'sent' and 'bg-info' or rfq.state == 'in_progress' and 'bg-primary' or rfq.state == 'done' and 'bg-secondary' or rfq.state == 'assigned' and 'bg-success' or 'bg-light text-dark'}">
                                    <t t-if="rfq.state == 'sent'">Open for Quotes</t>
                                    <t t-elif="rfq.state == 'in_progress'">Under Review</t>
                                    <t t-elif="rfq.state == 'done'">Closed</t>
                                    <t t-elif="rfq.state == 'assigned'">Vendor Selected</t>
                                    <t t-else="" t-esc="rfq.state"/>
                                </span>
                            </div>
                        </div>
                    </t>
                    
                    <t t-set="card_body">
                        
                        <!-- Winner Notification -->
                        <t t-if="rfq.state == 'assigned' and rfq.approved_vendor_id.id == request.env.user.partner_id.id">
                            <div class="alert alert-success">
                                <h5><i class="fa fa-trophy"/> Congratulations!</h5>
                                <p class="mb-0">Your quote has been selected for this service. Check your assignments for details.</p>
                            </div>
                        </t>
                        
                        <!-- RFQ Details -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <h5>Request Details</h5>
                                <dl class="row">
                                    <dt class="col-sm-4">Service Type</dt>
                                    <dd class="col-sm-8" t-esc="rfq.service_type"/>
                                    
                                    <dt class="col-sm-4">Event</dt>
                                    <dd class="col-sm-8">
                                        <t t-if="rfq.crm_lead_id" t-esc="rfq.crm_lead_id.name"/>
                                        <t t-elif="rfq.project_id" t-esc="rfq.project_id.name"/>
                                        <t t-else="">-</t>
                                    </dd>
                                    
                                    <dt class="col-sm-4">Event Date</dt>
                                    <dd class="col-sm-8">
                                        <span t-field="rfq.event_date" t-options='{"format": "MMMM dd, yyyy"}'/>
                                    </dd>
                                    
                                    <dt class="col-sm-4">Quote Deadline</dt>
                                    <dd class="col-sm-8">
                                        <t t-if="rfq.closing_date">
                                            <span t-field="rfq.closing_date" t-options='{"format": "MMMM dd, yyyy"}'/>
                                        </t>
                                        <t t-else="">As soon as possible</t>
                                    </dd>
                                    
                                    <dt class="col-sm-4">Expected Amount</dt>
                                    <dd class="col-sm-8">
                                        <t t-if="rfq.estimated_budget">
                                            $<t t-esc="'{:,.2f}'.format(rfq.estimated_budget)"/>
                                        </t>
                                        <t t-else="">Open</t>
                                    </dd>
                                </dl>
                            </div>
                            <div class="col-md-6">
                                <h5>Contact</h5>
                                <dl class="row">
                                    <dt class="col-sm-4">Requested By</dt>
                                    <dd class="col-sm-8" t-field="rfq.user_id.name"/>
                                    
                                    <t t-if="rfq.company_id.email">
                                        <dt class="col-sm-4">Email</dt>
                                        <dd class="col-sm-8" t-field="rfq.company_id.email"/>
                                    </t>
                                    
                                    <t t-if="rfq.company_id.phone">
                                        <dt class="col-sm-4">Phone</dt>
                                        <dd class="col-sm-8" t-field="rfq.company_id.phone"/>
                                    </t>
                                </dl>
                            </div>
                        </div>
                        
                        <!-- Description -->
                        <t t-if="rfq.service_description">
                            <h5>Service Requirements</h5>
                            <div class="mb-4 p-3 bg-light rounded" t-field="rfq.service_description"/>
                        </t>
                        
                        <!-- Quote Submission Form -->
                        <t t-set="my_quote" t-value="rfq.quote_history_ids.filtered(lambda q: q.vendor_id.id == request.env.user.partner_id.id)[:1]"/>
                        
                        <t t-if="rfq.state in ('sent', 'in_progress')">
                            <div class="card mb-4">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0">
                                        <t t-if="my_quote">Update Your Quote</t>
                                        <t t-else="">Submit Your Quote</t>
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <form method="POST" t-attf-action="/my/vendor/rfq/#{rfq.id}/submit" class="row g-3">
                                        <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                        
                                        <div class="col-md-4">
                                            <label for="quoted_amount" class="form-label">Your Quote Amount ($)</label>
                                            <input type="number" step="0.01" min="0" 
                                                   class="form-control" id="quoted_amount" name="quoted_amount" 
                                                   t-att-value="my_quote.quoted_price if my_quote else ''"
                                                   placeholder="0.00" required="required"/>
                                        </div>
                                        
                                        <div class="col-md-8">
                                            <label for="notes" class="form-label">Notes / Comments</label>
                                            <textarea class="form-control" id="notes" name="notes" rows="2" 
                                                      placeholder="Any additional details about your quote..."><t t-if="my_quote" t-esc="my_quote.notes or ''"/></textarea>
                                        </div>
                                        
                                        <div class="col-12">
                                            <button type="submit" class="btn btn-primary">
                                                <i class="fa fa-paper-plane"/> 
                                                <t t-if="my_quote">Update Quote</t>
                                                <t t-else="">Submit Quote</t>
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </t>
                        
                        <!-- Your Quote Status (if submitted and RFQ closed) -->
                        <t t-if="my_quote and rfq.state in ('done', 'assigned')">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0">Your Submitted Quote</h5>
                                </div>
                                <div class="card-body">
                                    <dl class="row mb-0">
                                        <dt class="col-sm-3">Quoted Amount</dt>
                                        <dd class="col-sm-9">$<t t-esc="'{:,.2f}'.format(my_quote.quoted_price)"/></dd>
                                        
                                        <dt class="col-sm-3">Submitted On</dt>
                                        <dd class="col-sm-9" t-field="my_quote.quote_date" t-options='{"format": "medium"}'/>
                                        
                                        <t t-if="my_quote.notes">
                                            <dt class="col-sm-3">Your Notes</dt>
                                            <dd class="col-sm-9" t-esc="my_quote.notes"/>
                                        </t>
                                        
                                        <dt class="col-sm-3">Status</dt>
                                        <dd class="col-sm-9">
                                            <t t-if="rfq.approved_vendor_id.id == request.env.user.partner_id.id">
                                                <span class="badge bg-success">Selected</span>
                                            </t>
                                            <t t-elif="rfq.state == 'assigned'">
                                                <span class="badge bg-secondary">Not Selected</span>
                                            </t>
                                            <t t-else="">
                                                <span class="badge bg-info">Under Review</span>
                                            </t>
                                        </dd>
                                    </dl>
                                </div>
                            </div>
                        </t>
                        
                    </t>
                </t>
                
                <!-- Back button -->
                <div class="mt-4">
                    <a href="/my/vendor/rfq" class="btn btn-secondary">
                        <i class="fa fa-arrow-left"/> Back to RFQ List
                    </a>
                </div>
                
            </t>
        </template>
        
    </data>
</odoo>
