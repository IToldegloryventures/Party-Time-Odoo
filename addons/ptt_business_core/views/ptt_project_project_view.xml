<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!--
        PTT Project Form View Extension
        
        Adds CLIENT, FINANCIALS, and VENDORS tabs for sales team workflow.
        These tabs replicate functionality from legacy DJ Event Planner system.
        
        Tab Structure:
        - CLIENT: All Lead Intake info from CRM (contact, event details)
        - FINANCIALS: SO/Invoice data + profitability (vendor costs, margin)
        - VENDORS: Assign vendors, send work orders, track acceptance status
        - PTT Event Details: (existing) Additional event details
        
        FIELD NAMING:
        - All custom fields use ptt_ prefix (Party Time Texas)
        - Reference: https://www.odoo.com/documentation/19.0/developer/reference/backend/orm.html
    -->
    <record id="view_project_form_ptt" model="ir.ui.view">
        <field name="name">project.project.form.ptt</field>
        <field name="model">project.project</field>
        <field name="inherit_id" ref="project.edit_project"/>
        <field name="arch" type="xml">
            <!-- HIDE problematic stage_id field in header that causes OwlError -->
            <!-- Base Odoo view has stage_id with statusbar_duration widget that fails when stages don't exist -->
            <xpath expr="//header/field[@name='stage_id']" position="replace">
                <field name="stage_id" invisible="1"/>
            </xpath>
            
            <!-- Add Project Header/Banner with key event information -->
            <xpath expr="//sheet" position="before">
                <div class="oe_title_header" style="background-color: #f8f9fa; padding: 20px; margin-bottom: 15px; border-radius: 4px; border: 1px solid #dee2e6;">
                    <!-- Event ID Header -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <h2 style="margin: 0; font-weight: bold;">
                                Event: <field name="ptt_event_id" readonly="1" style="display: inline; margin-right: 10px;"/>
                            </h2>
                        </div>
                    </div>
                    
                    <!-- Row 1: Event Date/Time, Type, Client -->
                    <div class="row mb-2">
                        <div class="col-md-4">
                            <div class="o_form_label" style="font-weight: bold; margin-bottom: 5px;">Event Date &amp; Time:</div>
                            <div>
                                <field name="ptt_event_date" readonly="1" style="display: inline-block; margin-right: 10px;"/>
                                <field name="ptt_event_time" readonly="1" style="display: inline-block;"/>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="o_form_label" style="font-weight: bold; margin-bottom: 5px;">Event Type:</div>
                            <div>
                                <field name="ptt_event_type" readonly="1"/>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="o_form_label" style="font-weight: bold; margin-bottom: 5px;">Client:</div>
                            <div>
                                <field name="partner_id" readonly="1" widget="many2one"/>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Row 2: Project Manager, Stage, Profit Margin -->
                    <div class="row">
                        <div class="col-md-4">
                            <div class="o_form_label" style="font-weight: bold; margin-bottom: 5px;">Project Manager:</div>
                            <div>
                                <field name="user_id" readonly="1" widget="many2one"/>
                            </div>
                        </div>
                        <div class="col-md-4" groups="project.group_project_stages">
                            <div class="o_form_label" style="font-weight: bold; margin-bottom: 5px;">Project Stage:</div>
                            <div>
                                <field name="stage_id" readonly="1" widget="many2one" groups="project.group_project_stages"/>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="o_form_label" style="font-weight: bold; margin-bottom: 5px;">Profit Margin:</div>
                            <div>
                                <field name="ptt_profit_margin" readonly="1" widget="percentage"/>
                            </div>
                        </div>
                    </div>
                </div>
            </xpath>
            
            <!-- Add CLIENT, FINANCIALS, VENDORS tabs before existing PTT Event Details -->
            <xpath expr="//sheet/notebook" position="inside">
                <!-- ===================================== -->
                <!-- CLIENT TAB (Lead Intake from CRM)    -->
                <!-- ===================================== -->
                <page name="ptt_client_tab" string="Client">
                    <!-- Primary Contact (from CRM) -->
                    <group string="Primary Contact">
                        <group>
                            <field name="partner_id" string="Client"/>
                            <field name="ptt_crm_lead_id" string="CRM Lead"/>
                        </group>
                        <group invisible="not ptt_crm_lead_id">
                            <field name="ptt_preferred_contact_method" invisible="not ptt_crm_lead_id"/>
                            <field name="ptt_date_of_call" invisible="not ptt_crm_lead_id"/>
                        </group>
                    </group>
                    
                    <!-- 2nd POC (Signing Authority) - from CRM Lead Intake -->
                    <group string="2nd POC (Signing Authority)" invisible="not ptt_crm_lead_id">
                        <group>
                            <field name="ptt_second_poc_name" invisible="not ptt_crm_lead_id"/>
                            <field name="ptt_second_poc_phone" invisible="not ptt_crm_lead_id"/>
                        </group>
                        <group>
                            <field name="ptt_second_poc_email" invisible="not ptt_crm_lead_id"/>
                        </group>
                    </group>
                    
                    <!-- Event Overview - from CRM Lead Intake -->
                    <group string="Event Overview">
                        <group>
                            <field name="ptt_event_id"/>
                            <field name="ptt_event_type"/>
                            <field name="ptt_event_date"/>
                            <field name="ptt_event_time"/>
                        </group>
                        <group>
                            <field name="ptt_guest_count"/>
                            <field name="ptt_total_hours"/>
                            <field name="ptt_venue_booked" invisible="not ptt_crm_lead_id"/>
                            <field name="ptt_venue_name"/>
                        </group>
                    </group>
                    
                    <!-- Finance Contact (for corporate clients) -->
                    <group string="Finance Contact (Corporate)" invisible="not ptt_crm_lead_id">
                        <group>
                            <field name="ptt_cfo_name" invisible="not ptt_crm_lead_id"/>
                            <field name="ptt_cfo_phone" invisible="not ptt_crm_lead_id"/>
                        </group>
                        <group>
                            <field name="ptt_cfo_email" invisible="not ptt_crm_lead_id"/>
                            <field name="ptt_cfo_contact_method" invisible="not ptt_crm_lead_id"/>
                        </group>
                    </group>
                </page>
                
                <!-- ===================================== -->
                <!-- FINANCIALS TAB (SO + Profitability)  -->
                <!-- ===================================== -->
                <page name="ptt_financials_tab" string="Financials">
                    <!-- Sale Order & Revenue -->
                    <group string="Revenue">
                        <group>
                            <field name="sale_order_id"/>
                            <field name="ptt_total_revenue" widget="monetary"/>
                        </group>
                        <group>
                            <field name="ptt_revenue_per_guest" widget="monetary"/>
                            <field name="ptt_guest_count" string="Guest Count"/>
                        </group>
                    </group>
                    
                    <!-- Vendor Costs -->
                    <group string="Vendor Costs">
                        <group>
                            <field name="ptt_total_vendor_cost" widget="monetary"/>
                        </group>
                        <group>
                            <field name="ptt_cost_per_guest" widget="monetary"/>
                        </group>
                    </group>
                    
                    <!-- Profitability -->
                    <group string="Profitability">
                        <group>
                            <field name="ptt_gross_profit" widget="monetary"/>
                        </group>
                        <group>
                            <field name="ptt_profit_margin" widget="percentage"/>
                        </group>
                    </group>
                </page>
                
                <!-- ===================================== -->
                <!-- VENDORS TAB (Vendor Assignments)     -->
                <!-- This is where internal staff assigns -->
                <!-- actual vendors to the event          -->
                <!-- NOTE: Portal features (Send WO, etc) -->
                <!-- are added by ptt_vendor_management   -->
                <!-- ===================================== -->
                <page name="ptt_vendors_tab" string="Vendors">
                    <!-- Internal Event Team -->
                    <group string="Internal Event Team">
                        <group>
                            <field name="user_id" string="Project Manager"/>
                            <field name="ptt_lead_coordinator_id"/>
                        </group>
                        <group>
                            <field name="ptt_onsite_contact_id"/>
                        </group>
                    </group>
                    
                    <!-- Vendor Assignments (basic view - portal features in ptt_vendor_management) -->
                    <group string="Vendor Assignments">
                        <field name="ptt_vendor_assignment_ids" nolabel="1">
                            <list editable="bottom">
                                <field name="service_type"/>
                                <field name="vendor_id"/>
                                <field name="ptt_status" widget="badge" 
                                       decoration-warning="ptt_status == 'pending'"
                                       decoration-success="ptt_status == 'confirmed'"
                                       decoration-info="ptt_status == 'completed'"
                                       decoration-muted="ptt_status == 'cancelled'"/>
                                <field name="actual_cost" widget="monetary"/>
                                <field name="ptt_confirmed_date" optional="show"/>
                            </list>
                            <form>
                                <sheet>
                                    <group>
                                        <group>
                                            <field name="service_type"/>
                                            <field name="vendor_id"/>
                                            <field name="ptt_status"/>
                                        </group>
                                        <group>
                                            <field name="actual_cost" widget="monetary"/>
                                            <field name="ptt_arrival_time"/>
                                            <field name="ptt_confirmed_date"/>
                                        </group>
                                    </group>
                                    <group string="Vendor Contact">
                                        <group>
                                            <field name="ptt_contact_person"/>
                                            <field name="ptt_contact_phone"/>
                                        </group>
                                    </group>
                                    <group string="Notes">
                                        <field name="notes" nolabel="1"/>
                                        <field name="ptt_equipment_notes" nolabel="1"/>
                                    </group>
                                </sheet>
                            </form>
                        </field>
                    </group>
                </page>
                
                <!-- ===================================== -->
                <!-- PTT EVENT DETAILS (Existing)         -->
                <!-- ===================================== -->
                <page name="ptt_event_details" string="Event Details">
                    <!-- Event Schedule -->
                    <group string="Event Schedule">
                        <group>
                            <field name="ptt_setup_start_time"/>
                            <field name="ptt_event_start_time"/>
                        </group>
                        <group>
                            <field name="ptt_event_end_time"/>
                            <field name="ptt_total_hours"/>
                            <field name="ptt_teardown_deadline"/>
                        </group>
                    </group>
                    
                    <!-- Event Details -->
                    <group string="Event Details">
                        <group>
                            <field name="ptt_theme_dress_code"/>
                            <field name="ptt_special_requirements_desc"/>
                        </group>
                        <group>
                            <field name="ptt_inclement_weather_plan"/>
                            <field name="ptt_parking_restrictions_desc"/>
                        </group>
                    </group>
                </page>
            </xpath>
        </field>
    </record>
</odoo>
