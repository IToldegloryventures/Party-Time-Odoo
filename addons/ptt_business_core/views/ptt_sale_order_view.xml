<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!--
        PTT Sale Order Form View Extension
        Per Odoo 19 Sales docs: https://www.odoo.com/documentation/19.0/applications/sales/sales/sales_quotations.html
    -->
    
    <record id="view_sale_order_form_ptt" model="ir.ui.view">
        <field name="name">sale.order.form.ptt</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_order_form"/>
        <field name="arch" type="xml">
            
            <!-- Add Approve Quote button in header -->
            <xpath expr="//button[@name='action_quotation_send']" position="before">
                <button name="action_approve_quote" 
                        string="Approve Quote" 
                        type="object"
                        class="btn-primary"
                        invisible="x_is_approved or state != 'draft'"
                        groups="ptt_business_core.group_quote_approver"/>
            </xpath>
            
            <!-- Add approval status info after state field -->
            <xpath expr="//field[@name='state']" position="after">
                <field name="x_is_approved" widget="boolean_toggle" readonly="1"
                       invisible="state not in ('draft', 'sent')"/>
            </xpath>
            
            <!-- Add PTT Contract & Payment section before order lines -->
            <xpath expr="//field[@name='order_line']" position="before">
                <group string="PTT Quote Approval &amp; Contract Status" col="4">
                    <group>
                        <field name="x_retainer_amount" widget="monetary"/>
                        <field name="x_is_approved" readonly="1"/>
                        <field name="x_approved_by" readonly="1" invisible="not x_is_approved"/>
                        <field name="x_approved_date" readonly="1" invisible="not x_is_approved"/>
                    </group>
                    <group>
                        <field name="x_contract_status"/>
                        <field name="x_contract_signed_date" readonly="1" invisible="x_contract_status != 'signed'"/>
                        <field name="x_retainer_paid"/>
                        <field name="x_retainer_paid_date" invisible="not x_retainer_paid"/>
                    </group>
                </group>
            </xpath>
            
            <!-- Add Contract and Retainer action buttons in button_box -->
            <xpath expr="//div[@name='button_box']" position="inside">
                <button name="action_mark_contract_signed" 
                        type="object"
                        class="oe_stat_button"
                        icon="fa-file-signature"
                        invisible="x_contract_status == 'signed' or state != 'sale'">
                    <span class="o_stat_text">Mark Contract Signed</span>
                </button>
                <button name="action_mark_retainer_paid" 
                        type="object"
                        class="oe_stat_button"
                        icon="fa-dollar"
                        invisible="x_retainer_paid or state != 'sale'">
                    <span class="o_stat_text">Mark Retainer Paid</span>
                </button>
            </xpath>
            
        </field>
    </record>
    
    <!-- Sale Order Tree View - Add approval status column -->
    <record id="view_sale_order_tree_ptt" model="ir.ui.view">
        <field name="name">sale.order.tree.ptt</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_quotation_tree"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='state']" position="before">
                <field name="x_is_approved" string="Approved" widget="boolean"/>
            </xpath>
        </field>
    </record>
    
    <!-- Sale Order Line List View - Add Cost, Target Margin, and Target Margin Price fields -->
    <record id="view_sale_order_line_tree_ptt" model="ir.ui.view">
        <field name="name">sale.order.line.tree.ptt</field>
        <field name="model">sale.order.line</field>
        <field name="inherit_id" ref="sale.view_order_line_tree"/>
        <field name="arch" type="xml">
            <!-- Add Cost, Target Margin, and Target Margin Price fields after Unit Price -->
            <xpath expr="//field[@name='price_unit']" position="after">
                <field name="purchase_price" string="Cost" widget="monetary" 
                       options="{'currency_field': 'currency_id'}" 
                       optional="show" groups="base.group_user"/>
                <field name="x_target_margin" optional="show"/>
                <field name="x_target_margin_price" string="Target Price" widget="monetary"
                       options="{'currency_field': 'currency_id'}" 
                       optional="show"/>
            </xpath>
        </field>
    </record>
    
    <!-- Sale Order Line Form View - Add Target Margin and Target Margin Price fields (embedded in order form) -->
    <record id="view_sale_order_form_line_ptt" model="ir.ui.view">
        <field name="name">sale.order.form.line.ptt</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_order_form"/>
        <field name="arch" type="xml">
            <!-- Add Target Margin and Target Margin Price fields in order line form view (after purchase_price from sale_margin) -->
            <xpath expr="//field[@name='order_line']//form//field[@name='purchase_price']" position="after">
                <field name="x_target_margin"/>
                <field name="x_target_margin_price" widget="monetary" 
                       options="{'currency_field': 'currency_id'}"/>
            </xpath>
        </field>
    </record>
    
</odoo>
